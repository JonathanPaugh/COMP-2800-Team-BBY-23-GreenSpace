<!DOCTYPE html>
<html>

<head>
    <title>GreenSpace</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link href="/css/slider.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
    <style>
        body {
            min-height: 100vh;
        }

        img {
            border: 1px solid #CCC;
            border-radius: 3px;
        }

        .tracker-section  {
            background-color: var(--color-container);
        }

        .tracker-plant-image {
            width: 25vw;
            height: 25vw;
            object-fit: cover;
        }

        .time-slider {
            width: 100%;
            height: 8px;
        }
        
        @media only screen and (max-width: 576px) {
            .plant-taxonomy {
                padding: 0.5rem 0.25rem;
            }

            .list-group-item {
                padding: 0.25rem 0.25rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="d-flex flex-column">
        <div class="flex-grow-1 p-5">
            <div class="tracker-section container-fluid ">
                <div class="tracker-options row p-3">
                </div>
            </div>
            <div class="time-container my-5">
                <input class="time-slider" type="range" min="0" max="100" value="0">
                <div class="d-flex justify-content-between">
                    <div>0</div>
                    <div>25</div>
                    <div>50</div>
                    <div>75</div>
                    <div>100</div>
                </div>
            </div>
            <div class="tracker-section container-fluid">
                <div class="tracker-plants row p-3">
            </div>
        </div>
        
    </div>
    

    <!-- Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
        </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous">
        </script>

    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-storage.js"></script>

    <script src="/js/general.js"></script>
    <script src="/js/firebase.js"></script>
    <script src="/js/init.js"></script>

    <!-- Scripts -->
    <script src="/js/search-plant.js"></script>
    <script>
        var type = getUrlQuery().get("type");
        var typeId = getUrlQuery().get("typeId");

        var selectedPlant;

        $(document).ready(() => {
            createOptions();
            displayPlants();

            $(".time-slider").on("input change", timeUpdate);
        });

        function searchInit() {
            searchPlantInit(searchPlantSuccess, searchPlantError);
        }

        function searchPlantSuccess(plant, query) {
            $(".selected-plant").empty();
            selectedPlant = plant;
            createDiv()
                .appendTo(".selected-plant")
                .addClass("search-success pt-4 text-success text-center")
                .html(plant.primaryCommonName);

            if (plant.images) {
                createElement("img")
                    .appendTo(".selected-plant")
                    .addClass("img-fluid")
                    .attr("src", plant.images[0]);
            }
            
        }

        function searchPlantError(error) {
            console.log(error);
            $(".selected-plant").empty();
            createDiv()
                .appendTo(".selected-plant")
                .addClass("search-error pt-4 text-danger text-center")
                .html(error.responseText);
        }

        function createOptions() {
            fetchTemplate("tracker/tracker-option-create.html", data => {
                let create = $(data).appendTo(".tracker-options");
                create.find(".tracker-option-create").click(() => {
                    fetchTemplate("tracker/tracker-modal-create.html", data => {
                        $("body").prepend(data);
                        searchInit();
                        let modal = $(".tracker-modal-create");
                        modal.modal("show");
                        modal.on("hidden.bs.modal", event => {
                            event.preventDefault();
                            modal.remove();
                        });
                        $(".tracker-modal-create-button").click(() => {
                            if (selectedPlant) {
                                addPlant(selectedPlant);
                                modal.modal("hide");
                                modal.remove();
                            } else {
                                addPlantError();
                            }
                        });
                    });
                });
            });
        }

        function addPlant(plant) {
            database.collection("tracker")
                .where("_type", "==", type)
                .where("_typeId", "==", typeId)
                .get()
                .then(async function(trackers) {

                let docs = trackers.docs;

                if (!docs.length) {
                    await database.collection("tracker").add({
                        _type: type,
                        _typeId: typeId,
                    }).then(tracker => {
                        docs.push(tracker);
                    });
                }

                console.log(docs.length);

                for (let tracker of docs) {
                    console.log(tracker.id);
                    let trackerRef = database.collection("tracker").doc(tracker.id);
                    await trackerRef.collection("plants").add({
                        id: plant.uniqueId,
                        image: plant.images ? plant.images[0] : null,
                        date: new Date()
                    });
                }

                redirect("tracker.html");
            });
        }

        function addPlantError() {
            $(".selected-plant").empty();
            createDiv()
                .appendTo(".selected-plant")
                .addClass("search-error pt-4 text-danger text-center")
                .html("Please search for a plant to create");
        }

        function displayPlants() {
            database.collection("tracker")
                .where("_type", "==", type)
                .where("_typeId", "==", typeId)
                .get()
                .then(trackers => {

                trackers.docs.forEach(tracker => {
                    let trackerRef = database.collection("tracker").doc(tracker.id);
                    trackerRef.collection("plants").get().then(plants => {
                        plants.docs.forEach(plant => {
                            createPlant(plant.data().id, plant.data().image, getAge(plant.data().date.toDate()))
                        });
                    });
                });
            });
        }

        function createPlant(id, image, date) {
            request("/get-plant", { id: id }, plant => {
                fetchTemplate("/tracker/tracker-plant.html", data => {
                    let item = $(data).appendTo(".tracker-plants");
                    item.find(".tracker-plant-name").html(plant.primaryCommonName);
                    item.find(".tracker-plant-image").attr("src", image);
                    item.find(".tracker-plant-age").attr("default", date).html(date);
                });
            });
        }

        function getAge(date) {
            let age = new Date(Date.now() - date.getTime());
            return Math.abs(age.getUTCFullYear() - 1970);
        }

        function timeUpdate() {
            let value = parseInt($(this).val());
            let age = $(".tracker-plant-age");
            let ageValue = parseInt(age.attr("default"));
            age.html(ageValue + value);
        }
    </script>
</body>

</html>