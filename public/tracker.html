<!DOCTYPE html>
<html>

<head>
    <title>GreenSpace</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
    <style>
        body {
            min-height: 100vh;
        }

        .tracker-section  {
            background-color: var(--color-container);
        }
    </style>
</head>

<body>
    <div class="d-flex flex-column">
        <div class="flex-grow-1 p-5">
            <div class="tracker-section container-fluid my-5">
                <div class="tracker-options row p-3">
                </div>
            </div>
    
            <div class="tracker-section container-fluid">
                <div class="tracker-plants row p-3">
            </div>
        </div>
    </div>
    

    <!-- Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
        </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous">
        </script>

    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-storage.js"></script>

    <script src="/js/general.js"></script>
    <script src="/js/firebase.js"></script>
    <script src="/js/init.js"></script>

    <!-- Scripts -->
    <script src="/js/search-plant.js"></script>
    <script>
        var type = getUrlQuery().get("type");
        var typeId = getUrlQuery().get("typeId");

        var selectedPlant;

        $(document).ready(() => {
            createOptions();
            displayPlants();
        });

        function searchInit() {
            searchPlantInit(searchPlantSuccess, searchPlantError);
        }

        function searchPlantSuccess(plant, query) {
            $(".selected-plant").empty();
            selectedPlant = plant;
            createDiv()
                .appendTo(".selected-plant")
                .addClass("search-success pt-4 text-success text-center")
                .html(plant.primaryCommonName);
        }

        function searchPlantError(error) {
            console.log(error);
            $(".selected-plant").empty();
            createDiv()
                .appendTo(".selected-plant")
                .addClass("search-error pt-4 text-danger text-center")
                .html(error.responseText);
        }

        function createOptions() {
            fetchTemplate("tracker/tracker-option-create.html", data => {
                let create = $(data).appendTo(".tracker-options");
                create.find(".tracker-option-create").click(() => {
                    fetchTemplate("tracker/tracker-modal-create.html", data => {
                        $("body").prepend(data);
                        searchInit();
                        let modal = $(".tracker-modal-create");
                        modal.modal("show");
                        modal.on("hidden.bs.modal", event => {
                            event.preventDefault();
                            modal.remove();
                        });
                        $(".tracker-modal-create-button").click(() => {
                            if (selectedPlant) {
                                addPlant(selectedPlant);
                                modal.modal("hide");
                                modal.remove();
                            } else {
                                addPlantError();
                            }
                        });
                    });
                });
            });
        }

        function addPlant(plant) {
            database.collection("tracker").add({
                _type: type,
                _typeId: typeId,
                id: plant.uniqueId,
                image: plant.images ? plant.images[0] : null,
            }).then(() => {
                selectedPlant = null;
                redirect("tracker.html");
            });
        }

        function addPlantError() {
            $(".selected-plant").empty();
            createDiv()
                .appendTo(".selected-plant")
                .addClass("search-error pt-4 text-danger text-center")
                .html("Please search for a plant to create");
        }

        function displayPlants() {
            database.collection("tracker")
                .where("_type", "==", type)
                .where("_typeId", "==", typeId)
                .get()
                .then(plants => {
                plants.docs.forEach(plant => {
                    createPlant(plant.data().id, plant.data().image)
                    console.log(plant);
                });
            });
        }

        function createPlant(name, image) {
            fetchTemplate("/tracker/tracker-plant.html", data => {
                let plant = $(data).appendTo(".tracker-plants");
                plant.find(".tracker-plant-name").html(name);
                plant.find(".tracker-plant-image").attr("src", image);
            });
        }
    </script>
</body>

</html>