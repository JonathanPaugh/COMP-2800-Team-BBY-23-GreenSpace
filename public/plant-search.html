<!DOCTYPE html>
<html>

<head>
    <title>GreenSpace</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
    <style>
        img {
            border: 1px solid #CCC;
            border-radius: 3px;
        }

        .plant-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2vw;
        }

        .plant-gallery-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .plant-taxonomy {
            background-color: #EEE;
        }

        .list-group-item {
            background-color: var(--color-container);
        }

        @media only screen and (max-width: 576px) {
            .plant-taxonomy {
                padding: 0.5rem 0.25rem;
            }

            .list-group-item {
                padding: 0.25rem 0.25rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="card p-2 my-2">
            <form class="search-form form-group has-search flex-grow-1">
                <div class="input-group">
                    <input class="search-value form-control" type="text" list="search-suggestions" placeholder="Search Plants...">
                    <div class="input-group-append">
                        <a class="search-button" href="">
                            <i class="fa fa-search fa-2x ms-1 mt-1"></i>
                        </a>
                    </div>
                </div>
                <datalist id="search-suggestions">
                </datalist>
            </form>
        </div>
    </div>

    <div class="container-fluid plant-info">
    </div>

    <!-- Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
        </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous">
        </script>

    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-storage.js"></script>

    <script src="/js/general.js"></script>
    <script src="/js/firebase.js"></script>
    <script src="/js/init.js"></script>

    <!-- Scripts -->
    <script>
        $(document).ready(() => {
            $(".search-value").on("input", suggest);
            $(".search-button").click(search);
            $(".search-form").submit(search);

            $(window).resize(resize);

            querySearch();
        });

        function querySearch() {
            let query = getUrlQuery().get("search");
            if (query) {
                $(".search-value").val(query);
                search();
            }
        }

        function suggest() {
            request("/suggest-plants", { query: $(".search-value").val() }, plants => {
                $("#search-suggestions").empty();
                if (!plants.length) { return; }
                createSuggestions(new Set(plants));
            });
        }

        function createSuggestions(suggestions) {
            suggestions.forEach(suggestion => {
                createElement("option").appendTo("#search-suggestions").val(suggestion);
            });
        }

        function search(event) {
            if (event) {
                event.preventDefault();
            }

            let query = $(".search-value").val();
            let pattern = /\((.*?)\)/;

            if (query.match(pattern)) {
                query = query.match(pattern)[1];
            }

            $(".plant-info").empty();
            
            request("/search-plant", { query: query }, plant => {
                setUrlQuery("search", query);
                createInfo(
                    plant.primaryCommonName, 
                    plant.scientificName,
                    plant.speciesGlobal.informalTaxonomy,
                    plant.information?.snippet,
                    plant.information?.link,
                    {
                        phyllum: plant.speciesGlobal.phylum,
                        class: plant.speciesGlobal.taxclass,
                        order: plant.speciesGlobal.taxorder,
                        family: plant.speciesGlobal.family,
                        genus: plant.speciesGlobal.genus,
                        species: plant.scientificName.replace(plant.speciesGlobal.genus, "").trim()
                    },
                    plant.images
                );
            }, error => {
                createDiv().appendTo(".plant-info").addClass("card p-2 text-danger text-center").html(error.responseText);
                console.log(error);
            });

            $(".search-value").val("");
            $("#search-suggestions").empty();
        }

        function createInfo(name, scientific, description, snippet, link, taxonomy, images) {
            fetchTemplate("plant-info.html", data => {
                let info = $(".plant-info").html(data);

                info.find(".plant-name").html(name);
                info.find(".plant-scientific").html(scientific);
                info.find(".plant-description").html(description);
                info.find(".plant-snippet").html(snippet);
                info.find(".plant-link").attr("href", link);

                info.find(".plant-taxonomy-phyllum").html(taxonomy.phyllum);
                info.find(".plant-taxonomy-class").html(taxonomy.class);
                info.find(".plant-taxonomy-order").html(taxonomy.order);
                info.find(".plant-taxonomy-family").html(taxonomy.family);
                info.find(".plant-taxonomy-genus").html(taxonomy.genus);
                info.find(".plant-taxonomy-species").html(taxonomy.species);

                if (images) {
                    info.find(".plant-image").attr("src", images[0]).attr("alt", name);

                    let width;
                    images.slice(1).forEach(image => {
                        let container = createDiv()
                            .appendTo(info.find(".plant-gallery"))
                            .addClass("plant-gallery-container");

                        createElement("img")
                            .appendTo(container)
                            .addClass("plant-gallery-image")
                            .attr("src", image)
                            .attr("alt", name);

                        width = container.width();
                    });

                    resize();
                }
            });
        }

        function resize() {
            $(".plant-gallery").css("grid-auto-rows", $(".plant-gallery-container").width() + "px");
        }
    </script>
</body>

</html>