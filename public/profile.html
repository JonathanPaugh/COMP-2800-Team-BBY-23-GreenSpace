<!DOCTYPE html>
<html>

<head>
    <title>GreenSpace</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="css/profile.css">
</head>


<body>
    <div class="head"></div>
    <div class="wrapper">
        <div class="row1A">
            <div class="part1">profile image
                <div class="circle2">
                </div> 
            </div>
            <div class="row1-page1-part2">
                <div class="pro-info">
                    <p><div id="fp">Name:</div><div id="pro-name">Sample Name</div></p>
                    <p><div id="fp">Email:</div><div id="pro-email">firstLast@gmail.com</div></p>
                    <p><div id="fp">Website:</div><div id="pro-web" >www.123.com</div></p>
                    <p><div id="fp">Biography:</div><div id="pro-bio" >graphic designer</div></p>
                    <div id="check">
                        <button class ="btn btn-lg" onClick="location.href='/profile-2.html'">Edit</button>
                    </div>
                </div>                
            </div>
        </div>
        <div class="row2">
            <div class="nav_menu">
                <ul>
                    <li onclick="clickParts(0)" class="user-post true">
                        Reminders
                    </li>
                    <li onclick="clickParts(1)" class="user-favorites">
                        Collections
                    </li>
                    <li onclick="clickParts(2)" class="user-favorites">
                        Gallery
                    </li>
                    <li class="user-tracker">
                        Plant Tracker
                    </li>
                </ul>
            </div>
            
            <div class="blog-section click-part-content">
                <div class="section-title">My Reminders</div>
                <div class="section-create" style="height: 36px; ">
                    <input type="submitPost" id="MyButtonPost" onclick="openTab()" style="font-size: 22px;" value=" + Add One" readonly="readonly">
                </div>
                <!-- The Modal -->
                <div id="myModal" class="modal">

                    <!-- Modal content -->
                    <div class="modal-content">
                        <p class="close" onclick="closeTab()" style="font-size: 50px;">&times;</p>
                        <div class="modal-box">
                            
                            <div class="modal-title">
                                <input type="text" class="form-control ph-title" placeholder="Blog Title">
                            </div>
                            <div class="modal-text">
                                <textarea class="form-control placehold" aria-label="With textarea" placeholder="Write your reminder here..."></textarea>
                                <button class="buttons-right blog-posted col-2" onclick="createBlog()" 
                                style="font-size: 24px; float: right; margin-right: 15px; border: none;">Post</button>
                                <!-- <p style="color: black">Some text in the Modal..</p> -->
                            </div>
                            <!-- <div class="modal-date"></div> -->
                        </div>
                    </div>

                </div>


                <div class="blogs"></div>
            </div>
            <div class="collection click-part-content">
                <div class="favorite-collect">
                    
                </div>
                <!-- <div class="card">
                    <div class="card-body">
                        <h5><i class="far fa-comment"></i> Comments</h5>
                    </div>
            
                    <div class="card-body comment">
                       
                    </div>
                    <div class="card-body">
                        <form class="row g-3">
                            <div class="container-fluid">
                                <input id="comment-value" class="form-control" placeholder="Write your comment here">
                            </div>
                            <div class="col-auto">
                                <button id="comment-submit" type="button" class="btn">Post</button>
                            </div>
                        </form>
                    </div> -->
            
            
                </div>
            </div>
            <div class="gallery click-part-content">
                <div class="col">
                  <div class="card">
                  
                    
                    <input class="btn image-select" onclick="selectImage()" type="button" value="Add Image">
                    <div class="card-body ">
                        <!-- <input class="btn" onclick="addText()" type="button" value="Add Image"> -->
                      <h5 class="card-title">Special title treatment</h5>
                      <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>              
                    </div> 
                  </div>
                </div>

                <div class="container-fluid py-3" style="background-color: lightgrey;">
                    <div class="row gallery-images">
            
                        
                        <!-- <div class="gallery-images"></div> -->

                        
                        <!-- <div class="col-md-6">
                          <div class="card image-size">
                            <div class="card-body">
                              <h5 class="card-title">Special title treatment</h5>
                              <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
                              <button id="selectImage" class="btn-primary"onclick="selectImage()" style="font-size: 22px;">
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card image-size">
                              <div class="card-body ">
                                <h5 class="card-title">Special title treatment</h5>
                                <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
                                <a href="#" class="btn btn-primary">Go somewhere</a>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="card image-size">
                              <div class="card-body">
                                <h5 class="card-title">Special title treatment</h5>
                                <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
                                <a href="#" class="btn btn-primary">Go somewhere</a>
                              </div>
                            </div>
                          </div> -->
                    </div>
                </div>
                  
                     <!-- Picture go here -->
            </div>

        </div>
        <!-- <div class="col-1A">
            <div class="profile">
                hello profile
            </div>
        </div>
        <div class="col-2B">
            <div class="content">
                .
                <div class="text">
                    <h5 id="post-titles">My Posts</h5>
                    <div class="blogs-containter"></div>      
                </div>
            </div>
        </div> -->
    </div>
    
    <!-- Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
        </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous">
        </script>

    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-storage.js"></script>
    
    <script src="/js/general.js"></script>
    <script src="/js/firebase.js"></script>
    <script src="/js/init.js"></script>

    <!-- Scripts -->
    <script>
        // clickpart(0)
        $(document).ready(()=>{
            collection();
            requireLogin();
            showBlogs();
            showImages();
            changeTab();
        
            getProfile();
            getModal();
<<<<<<< HEAD
           
=======

            $(".user-tracker").click(() => {
                withUser(user => {
                    window.location.href = `tracker.html?type=user&typeId=${user.id}`;
                });
            });
>>>>>>> 4b5038f31007c212f8f29e881a3049715a2fde46
        })

        function collection() {
            withUser(user => {
               
               
                userCollect(user);
            })
        }
        function userCollect(user) {
            $(".favorite-collect").empty();
            getCollect(user);
        }
//http://localhost:3000/group-list.html?id=community-garden
        function getCollect(user) {
            var collectList = [database.collection("groups").doc("categories").collection("community-garden"),
                    database.collection("groups").doc("categories").collection("container-garden"),
                    database.collection("groups").doc("categories").collection("greenhouse-garden"),
                    database.collection("groups").doc("categories").collection("indoor-garden")];

                    collectList.forEach( category=>{

                        category.get().then(collection=>{
                            console.log("collection: ", collection);
                            collection.docs.forEach(garden => {

                                var gardenRef = category.doc(garden.id);
                                
                                gardenRef.collection("posts").where("user", "==", user.data().name).get().then((posts)=>{
                                    
                                    posts.docs.forEach((post)=>{
                                        console.log(user.data().name);
                                        gardenRef.collection("posts").doc(post.id).get().then(doc=>{
                                            console.log(doc.data().user);
                                        });

                                    })
                                })
                            })
                        })
                    })

           
        }
        // function galleryCollection(doc) {
        //     withUser(user => {
        //         if(doc.data().user == user) {
        //             if(doc.data().likes > 0) {
        //                 makeCollection(doc);
        //             }
        //         }
        //     })
        // }

        // function postCollection(doc) {
        //     withUser(user => {
        //         if(doc.data().user == user) {
        //             if(doc.data().likes > 0) {
        //                 makeCollection(doc);
        //             }
        //         }
        //     })
        // }
       
        // function makeCollection(doc) {
        //     console.log("content", doc.data().likes);
        // }
        /*
        * Reference begins: 
        * @see https://www.youtube.com/watch?v=PJe5Cc6iybQ
        */
        function changeTab(){
            $('.nav_menu ul li').click(()=>{
                $(this).addClass('true').siblings().removeClass('true');
            })
        }
        // var button = document.querySelectorAll('.nav_menu ul li');
        var part_content = document.querySelectorAll('.click-part-content');
        function clickParts(i) {
            part_content.forEach(part=>{
                part.style.display='none';
            });
            part_content[i].style.display = 'block';
        }
        clickParts(0);
        /*
        * Reference ends
        */
                
        
        
        const modal = document.getElementById("myModal");
        function getModal(){
            // clicks anywhere outside 
            window.onclick = function(event) {
                  if (event.target == modal) {
                 modal.style.display = "none";
                 }
            }
        }
        function closeTab() {
            modal.style.display = "none";
        }

        function openTab() {
            modal.style.display = "block";
        }
        function selectImage() {
            withUser(user=>{
                // var images = database.collection("users").doc(user.id).collection("gallery");
                var input = document.createElement('input');
                input.type = 'file';
                input.click();
                input.onchange = async function (selectAnImage) {
                    selectAnImage.preventDefault();
                    var fileSelected = selectAnImage.target.files[0];
                    var imagRef = storage.ref().child("users/" + user.id + "/gallery/" + fileSelected.name);
                    await imagRef
                    .put(fileSelected)
                    .then(async function (snapshot) {
                        var link = await snapshot.ref.getDownloadURL();
                        createImageDiv(link);
                    });
                } 
            })

        }
       
        
        function createImageDiv(link) {
            fetchTemplate("profile-gallery.html", card=>{
                //card returnedï¼ŒappendTo
                var gallery_card = $(card).appendTo(".gallery-images"); 
                gallery_card.find(".card-image-gallery").attr("src",link);
            })
             
        }

        function showImages() {
            withUser(user => {
                var listRef = storage.ref().child("users/" + user.id).child("gallery");
                listRef.listAll().then(function(array){
                    array.items.forEach(function(imgRef){
                        imgRef.getDownloadURL().then(function(url){
                            createImageDiv(url);
                        })
                    })
                })
            })
        }
        function createBlog() {
            withUser(user => {
                //add user input to firebase 
                database.collection("users").doc(user.id).collection("blogs").add({
                    blog_title: $(".ph-title").val(),
                    blog_text: $(".placehold").val(),  
                    date: firebase.firestore.Timestamp.fromDate(new Date())
                })
                .then((docRef) => {
                    console.log("Document written with ID: ", docRef.id);
                    console.log(docRef.get());
                    //get document with data above from docRef
                    docRef.get().then(doc=>{
                        console.log(doc);
                        makeBlog(doc);
                        closeTab();
                    })
                     
                })
                .catch((error) => {
                 console.error("Error adding document: ", error);
                });
            })
        }
        
        function makeBlog(blog) { 

            fetchTemplate("profile-blog.html", card=>{
               let each = $(card);
               //set the doc data to the html selector
               each.find(".blog-title").html(blog.data().blog_title);
               each.find(".blog-content").html(blog.data().blog_text);  
               each.find(".reminder-tag").html(blog.data().blog_like);
               each.find(".date").html(blog.data().date.toDate().toLocaleString());

               $(".blogs").prepend(each);
               each.find(".blog-edit").click(function(){
                   setUrlQuery("blogId", blog.id);
                   redirect("profile-edit.html");
               })
               each.find(".blog-remove").click(function(){
                    withUser(user => {
                         each.remove(); 
                         database.collection("users").doc(user.id).collection("blogs").doc(blog.id).delete();
                    })
               })
               each.find(".blog-like").click(function(){
                    withUser(user => {
                        var doc = database.collection("users").doc(user.id).collection("blogs").doc(blog.id);
                        var reminder_count = each.find(".reminder-tag").html(); //it is a string
                            reminder_count = parseInt(reminder_count); //convert to number
                            each.find(".reminder-tag").html(++reminder_count); //increase it, then set back to html
                        doc.update({
                            blog_like: firebase.firestore.FieldValue.increment(1)
                        })
                    })
               })
            
        
             
               
            });
        }
        function getProfile() {
            withUser(user=>{
                $('#pro-name').html(user.data().name);
                $('#pro-email').html(user.data().email);
                $('#pro-web').html(user.data().website);
                $('#pro-bio').html(user.data().bio);
            })
            
        }

        function showBlogs() {
            withUser(user => {
                database.collection("users").doc(user.id).collection("blogs").orderBy("date", "asc").get().then((blogs)=>{
                        blogs.docs.forEach((blog)=>{
                         makeBlog(blog);
                        //  console.log("check: ", blog.data().date)
                     })
               
                });
            })
        }

    </script>


</body>

</html>